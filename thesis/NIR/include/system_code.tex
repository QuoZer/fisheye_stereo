\subsection{Передача изображений с виртуальных камер для обработки}

Unity в качестве основного языка программирования использует C\# и не позволяет импортировать 
выбранную библиотеку технического зрения OpenCV напрямую. Однако как уже упоминалось в секции 
\ref{sec:software}, данная среда позволяет интегрировать плагины, в том числе написанные на 
других языках программирования, в виде динамически подключаемых библиотек (DLL). Именно этот 
подход был использован для передачи изображений - была разработана библиотека с функциями для 
обработки снимков, которая компилировалась отдельно и затем импортировалась в Unity. 

Для реализации описанного в этой работе принципа и упрощения разработки в библиотеке были реализованы 
следующие функции:
\begin{itemize}
    \item initialize - выделяет память под нужные структуры, заполняет таблицу поиска и создаёт окна 
    для отображения будущих изображений.
    \item getImages - передаёт изображения в библиотеку и производит обработку изображений в 
    соответствии с аргументами. 
    \item takeScreenshot - производит ту же обработку входного изображения, что и предыдущая функция,
     но результат сохраняет в файл. 
    \item processImage - передаёт обратно в скрипт уже обработанные изображения для удобного отображения
    в интерфейсе Unity. 
    \item terminate - высвобождает память по завершении работы симуляции.      
\end{itemize}

Обработка, упомянутая в пунктах с функциями getImages и takeScreenshot, заключается в конвертации 
цветового пространства изображений (из RGBA, используемого в Unity, в BGR, используемый в OpenCV), 
горизонтальном зеркальном отображении (из-за разного положения точки отсчёта координат пикселей)
и, наконец, устранениb искажений в области интереса. Так как для наилучшей работы стереосопоставления
снимки должны быть синхронизированы (то есть получены камерами в один момент времени), обработка        % FIXME: ну не совсем одновременно и мб лучше это описать с другого ключа - типа функция может обрабатывать n снимков?
производится сразу для двух изображений. 

Также написан специальный скрипт, который управляет процессом взаимодействия симуляции и библиотеки. 
Эта программа имеет окно настроек, которое позволяет задать
используемые камеры, элементы управления параметрами  и выбрать область интереса с помощью задания углов.
 Внешний вид этого окна представлен на рисунке \ref{pic:connec_inter}.

\addimghere{connector_settings}{0.7}{Внешний вид окна настроек скрипта}{pic:connec_inter}

Сразу после запуска симуляции происходит запуск дополнительных вычислительных потоков для обработки 
кадров с каждой пары камер и передача настроек скриптом в библиотеку для построения таблиц поиска.           % FIXME: ну написано очень криво. Использование
Использование нескольких потоков позволяет не блокировать работу симуляции на время обработки изображений.  
Далее каждое обновление кадра скрипт считывает изображения с камер и помещает их в память соответствующего 
потока. Поток же работает независимо и обрабатывает каждую следующую пару изображений после готовности 
предыдущей. 